= База данных

База данных {dv} используется для хранения данных и части функциональности Системы: ролевой модели, представлений, поисковых запросов. Поддерживаются СУБД Microsoft SQL Server или PostgreSQL.

БД {dv} разделена логически на несколько частей:

* хранилище оперативных данных – здесь хранятся данные карточек, представлений, поисковых запросов, системная информация;
* хранилище архивных данных – здесь хранятся данные карточек, перемещенных в архив;
* хранилище журналов – здесь хранятся журналы работы {dv},
* хранилище метаданных – здесь хранятся различные служебные данные (временные таблицы с изменениями объектов, внутренними курсорами, файловыми курсорами, иконками, представлениями и данными поисковых запросов).

Оперативные данные всегда располагаются в основной БД {dv}. Архивные данные, журналы и метаданные могут храниться в основной БД или быть вынесены в отдельные _сателлитные БД_. Названия сателлитных БД совпадают с названием основной БД с добавлением постфикса:

* `_Archive` – у БД с архивными данными,
* `_Log` – у БД с журналами;
* `_Metadata` – у БД с метаданными.

Помимо указанных частей БД {dv} можно выделить еще одну – хранилище бинарных данных файлов, которое может полностью включаться в хранилище оперативных и архивных данных, или быть распределено между несколькими физическими хранилищами (ФС, другими БД).

Таким образом все части БД {dv} могут быть полностью размещены в единственной БД или распределены по нескольким физическим хранилищам.

image::dbSchema.png[]

== AlwaysOn

Microsoft SQL предоставляет функцию _Группы доступности AlwaysOn_ – решение высокой доступности и аварийного восстановления, являющееся альтернативой зеркальному отображению БД на уровне предприятия.

В {dv} функция AlwaysOn используется для распределения нагрузки – на реплики распределяются операции чтения:

* *Выполнение отчётов*. В случае, если у отчета выставлен признак "Только чтение", он будет выполняться на одной из вторичных реплик БП (без нагрузки на основную БД). Если отчёт записывает данные в БД, то запросы будут поступать на основной узел.
* *Получение карточек*. Вариант получения карточки из БД зависит от актуальности метки времени данной карточки: если есть реплика с актуальной меткой (проверяется по значению из серверного кэша или основного узла), то карточка будет получена из данной реплики, иначе – из основного узла.
* *Выполнение поисковых запросов и представлений.* Поисковые запросы и формирование представлений выполняются на репликах. Выбор реплики фиксируется в серверном кэше и в последующем используется для загрузки новых страниц представлений, а также работы остальных методов, работающих с поисковыми запросами и представлениями.

Полный список методов API {dv}, при выполнении которых могут использоваться реплики:

* GetCardXmlData;
* SectionReadRowsData;
* SearchCreateProcessor – все методы поисков;
* ViewCreateProcessor – все методы представлений;
* CardGetState;
* ReportGetData;
* RowGetData;
* RowGetHierarchy;
* CardGetType;
* SessionGetIdList;
* UserGetInfo.

Если данные из основной БД {dv} вытеснены в сателлитные БД, для них также создаются реплики, работа с которыми осуществляется по аналогичным правилам.

image::dbInAlwaysOnMode.png[dbInAlwaysOnMode]

С целью распределения нагрузки между репликами количество обращений к каждой фиксируется и используется при следующем запросе – выбирается реплика с минимальным количеством вызовов.