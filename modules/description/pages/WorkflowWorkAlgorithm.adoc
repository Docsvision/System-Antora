= Описание работы службы Workflow

Служба Workflow ведет групповую обработку БП: при наличии в системе нескольких активных БП (их поиском занимается "детектор активных процессов") часть из них будет обрабатываться параллельно; обрабатывающиеся параллельно процессы образуют группу обрабатываемых процессов. Пока служба обрабатывает эти БП, не вошедшие в неё активные процессы ожидают обработки в очереди процессов.

image::archWF.png[Описание работы службы Workflow]

Число параллельно обрабатываемых процессов, то есть число процессов в группе обрабатываемых процессов, определяется в настройках сервиса Workflow. Процессы в группе обрабатываемых процессов объединяет только то, что в какой-то момент времени они одновременно обрабатываются сервисом Workflow. Время начала и окончания обработки для каждого из этих процессов индивидуальны и никак не связаны с аналогичными параметрами остальных процессов группы. Таким образом, состав группы обрабатываемых процессов динамически изменяется.

Процессы из группы обрабатываются за разное время; при завершении обработки одного из процессов его место в группе занимает процесс из очереди ожидающих обработку.

Каждому процессу выделяется на обработку определенное время -- квант времени, длительность которого в общем случае зависит от приоритета процесса. Выделение на обработку процесса кванта времени не означает, что процесс обязан исполниться именно за этот период: на исполнение может потребоваться как меньше, так и больше времени. Если процесс не успел исполниться за отведенный квант времени, он возвращается в очередь процессов, ожидающих обработки.

Время исполнения каждой из составляющих процессы функций, в отличие от кванта времени, определяется в настройках сервиса и одинаково для всех функций. Если какая-то функция выполняется неприемлемо долго, содержащий ее процесс объявляется превысившим таймаут (но слишком долго работающая функция при этом продолжает выполняться до естественного или принудительного завершения).

Теоретически возможна ситуация, в которой все или почти все процессы из группы обрабатываемых процессов будут содержать неприемлемо долго работающие функции и тем самым препятствовать началу исполнения других активных процессов. Чтобы избежать этого, в настройках службы задается максимально допустимое число процессов, одновременно превысивших таймаут. Если это число превышено, то рабочий процесс принимает решение о перезагрузке.

Таким образом, в обработке процессов сервисом Workflow можно выделить следующие этапы:

. Поиск всех процессов в системе, активных в текущий момент времени.
. Составление списка активных процессов.
. Формирование из объектов полученного списка процессов очереди процессов, ожидающих обработки.
. Выборка процессов из очереди.
. Отправка на обработку -- освободившееся место в группе обрабатываемых занимает процесс, первый в очереди процессов.