= Работа в кластере

Нагрузка по обработке бизнес-процессов может быть распределена между несколькими экземплярами службы Workflow, запущенными на отдельных компьютерах – кластером Workflow.

Каждому экземпляру Workflow, входящему в кластер, администратором назначается определённая доля обрабатываемых БП. Нагрузка может быть распределена поровну или, например, (для двух сервисов) три (доля первого) к четырём (доля второго): приблизительно 43% процессов будет обрабатывать первый сервис, 57% – второй.

Алгоритм обработки БП в кластере Workflow:

. В зависимости от доли сервиса Workflow, ему назначается определенный участок чисел из ряда 0-1000. Например, для долей 3 / 4 – первому выделяется участок от 0 до 428, второму – 429-999. Данные значения хранятся в таблице `dvtable_{b4a2559b-45fd-4aba-919f-0f170ccddb5d}`: в поле `ProcessedLBound` – начальное значение, в поле `ProcessedUBound` – конечное.

. При запуске БП ему присваивается число от 0 до 1000 – количество миллисекунд во времени его запуска БП. Значение храниться в поле `dvtable_{0ef6bcca-7a09-4027-a3a2-d2eeeca1bf4d}.DateBeginMsecs`.

. Сервис Workflow выбирает для выполнения БП, у которого `DateBeginMsecs` попадает в промежуток `ProcessedLBound` - `ProcessedUBound`. 

Статистически данный способ позволяется достаточно точно распределить обработку бизнес-процессов между сервисами Workflow в соответствии с назначенным им долями.

. Если один из сервисов Workflow становится недоступен, доли перераспределяются между другими активными сервисами.

image::wfCluster.png[Распределение БП в кластере Workflow]